name: Install Modes (PR)

on:
  pull_request:

permissions:
  contents: read

jobs:
  test-install-modes:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mode: [numpy, jax, torch]
        profile: [regular, dev]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          if [ "${{ matrix.profile }}" = "dev" ]; then
            if [ "${{ matrix.mode }}" = "jax" ]; then
              uv sync --dev --extra jax
            elif [ "${{ matrix.mode }}" = "torch" ]; then
              uv sync --dev --extra torch
            else
              uv sync --dev
            fi
          else
            if [ "${{ matrix.mode }}" = "jax" ]; then
              uv sync --extra jax
            elif [ "${{ matrix.mode }}" = "torch" ]; then
              uv sync --extra torch
            else
              uv sync
            fi
          fi

      - name: Verify backend availability
        run: |
          if [ "${{ matrix.mode }}" = "jax" ]; then
            uv run python -c "from stl import registry; assert 'jax' in registry.backends()"
          elif [ "${{ matrix.mode }}" = "torch" ]; then
            uv run python -c "from stl import registry; assert registry.backends() == ['numpy']"
            uv run python -c "import torch; assert torch.__version__"
          else
            uv run python -c "from stl import registry; assert registry.backends() == ['numpy']"
          fi

      - name: Verify dev tools availability
        run: |
          if [ "${{ matrix.profile }}" = "dev" ]; then
            uv run python -c "import pytest; import pre_commit"
          else
            uv run python -c "import importlib.util; assert importlib.util.find_spec('pytest') is None"
            uv run python -c "import importlib.util; assert importlib.util.find_spec('pre_commit') is None"
          fi

      - name: Run tests (dev profile)
        if: matrix.profile == 'dev'
        run: uv run pytest -q

      - name: Run smoke test (regular profile)
        if: matrix.profile == 'regular'
        run: |
          if [ "${{ matrix.mode }}" = "jax" ]; then
            uv run python -c "import jax.numpy as jnp; from stl import Predicate, create_semantics; s = jnp.asarray([[0.1], [0.2]]); p = Predicate('p', fn=lambda sig, t: 0.3 - sig[t, 0]); sem = create_semantics('classical', backend='jax'); float(p.evaluate(s, sem, t=0))"
          elif [ "${{ matrix.mode }}" = "torch" ]; then
            uv run python -c "import torch; from stl import Predicate, create_semantics; s = torch.tensor([[0.1], [0.2]], dtype=torch.float64); p = Predicate('p', fn=lambda sig, t: 0.3 - sig[t, 0]); sem = create_semantics('classical', backend='numpy'); float(p.evaluate(s, sem, t=0))"
          else
            uv run python -c "import numpy as np; from stl import Predicate, create_semantics; s = np.asarray([[0.1], [0.2]], dtype=float); p = Predicate('p', fn=lambda sig, t: 0.3 - sig[t, 0]); sem = create_semantics('classical', backend='numpy'); float(p.evaluate(s, sem, t=0))"
          fi
